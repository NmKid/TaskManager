# Task Scheduler 仕様書

## 1. 概要
Google Tasks（ToDoリスト）とGoogle Calendar（カレンダー）を双方向に連携させ、AI (Gemini) を活用してタスクの自動スケジューリングを行うPythonツールの仕様です。

## 2. アーキテクチャ構成
*   **実行環境:** ローカル環境 (Windows)
*   **UI形態:** 簡易GUIアプリケーション (Flet または Tkinter)
    *   操作: ボタン押下によるステップ実行（振り分け開始 -> 実行開始）。
*   **開発言語:** Python 3.x
*   **API連携:**
    *   Google Calendar API
    *   Google Tasks API
    *   Gemini API (`google-generativeai`)
*   **構成方針:**
    *   Google Apps Script (GAS) は使用せず、Pythonから直接各種APIを操作する。
    *   Google Maps API は使用せず、移動時間の算出は「過去の履歴」または「Geminiによる推測」を用いる。
    *   **GUI:** Flet または Tkinter を使用した簡易デスクトップアプリとして実装する（ボタンによるステップ実行）。

## 3. 機能詳細

### 3.0. 対象範囲とリスト運用
*   **対象リスト:** タイトルが **`■`** で始まるタスクリストのみを本ツールの処理対象とする（例: `■仕事`, `■プライベート`）。
*   **Inbox:** タスクリスト `■メモ` をInbox（入り口）として扱う。
*   **除外:** `■` が付いていないリストは読み込み・操作の対象外とする。

### 3.1. 同期ロジック (Synchronize)
カレンダーとタスクの整合性を保つための同期ルールです。

*   **Calendar → Tasks (カレンダーからタスクへ)**
    *   **新規予定:** カレンダーに新しい予定が作成されると、対応するタスクをGoogle Tasksの **Inbox (`■メモ`)** に自動作成する。
    *   **削除・移動:** カレンダー上の予定が削除または移動されても、**Google Tasks側のタスクには影響を与えない（削除・変更しない）**。
        *   ※カレンダー側で削除された場合、タスク側のステータス（「予定済」等）との不整合は許容する（同期しない）。
*   **Tasks → Calendar (タスクからカレンダーへ)**
    *   未スケジュールのタスクを分析し、カレンダーの空き時間に自動登録する。
    *   **重複防止:**
        *   一度カレンダーに登録したタスクは、タスクタイトルを `【予定済】元のタスク名` に変更して視認性を高める。
        *   システム的な二重登録防止として、タスクの「メモ欄 (Notes)」末尾に `[Ref:EventID:xxxxx]` の形式でカレンダーイベントIDを記録する。

### 3.2. タスク分析と分割 (Analysis & Breakdown)
Gemini APIを使用してタスクの内容を分析します。

*   **分析項目:** 重要度、緊急度、所要時間、場所、コンテキスト。
*   **タスクの自動分割:**
    *   所要時間が長い、または工程が複数あるタスクは、Geminiが自動的に**サブタスク**に分割する。
    *   **処理:** 親タスクは「コンテナ（入れ物）」扱いとしてスケジューリング対象外とし、分割された**子タスク**個々をスケジューリング対象とする。親タスク名は `【分割済】...` 等に変更する。
        *   ※親タスクと子タスクの完了ステータスの連動は行わない（独立して管理する）。

        *   ※親タスクと子タスクの完了ステータスの連動は行わない（独立して管理する）。

### 3.3. タスクの振り分け (Organization)
*   **タイミング:** アプリ起動直後に実行。
*   **処理:** Inbox (`■メモ`) にあるタスクを分析し、最適な `■` 付きリストへ移動させる。
*   **未分類:** 適切な移動先が見つからない場合は、`■メモ` にそのまま残す。
*   **修正:** 誤ったリストに移動された場合は、ユーザーが**Google Tasks公式アプリ/Web**上で手動修正する。本ツールは再読み込み機能を提供する。

### 3.4. 自動スケジューリング (Scheduling)
*   **優先順位:** タスクの **期限 (Due Date)** を最優先とし、次いでAIが判断した重要度に基づいて配置する。
*   **空き枠探索:** カレンダーの `Free/Busy` 情報を取得し、空いている時間にパズル的にタスクを割り当てる。
*   **移動時間の考慮:**
    *   場所の移動が発生する場合（AIが場所を推定）、前後の予定との間に移動時間を確保する。
    *   移動時間が15分以上と予測される場合、カレンダー上に独立した「移動イベント」を作成する。
    *   移動時間の長さは、過去の同一区間の履歴を参照するか、履歴がない場合はGeminiに概算を出させる。
*   **制限事項:**
    *   スケジュール対象期間は最大「2週間先」までとする。
    *   当日の空きがない場合は翌日以降に繰り越す。

## 4. データ構造と管理
*   **ID紐付け:** `state_manager.py` 等を用いて、タスクIDとカレンダーイベントIDの紐付けを管理・永続化する。
*   **コンフィグ:** `config.py` にAPIキーやスケジュール期間などの設定を集約する。

## 5. 運用フロー
1.  ユーザーが `■メモ` にタスクを登録（またはCalendarに予定登録）。
2.  スクリプト/アプリを起動。
3.  **[自動] 振り分け処理**: `■メモ` から各 `■リスト` へタスクが移動される。
4.  **[手動] ユーザー確認**: ユーザーがタスクの振り分け結果を **Google Tasks公式アプリ等で確認・修正** する。
5.  **[手動] スケジュール実行**: ユーザーがGUI上の「実行」ボタンを押下。
6.  **[自動] 分析・スケジューリング**:
    *   Calendar → Tasks (Inbox) の同期。
    *   タスクの分析・分割。
    *   Calendar の空き枠への登録。
7.  GUI上で完了ログを確認。
