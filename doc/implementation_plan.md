# 要件分析と実装計画

## 1. 要件のまとめ

`specification.md` に基づく主要な要件は以下の通りです。

*   **目的**: Google Tasks と Google Calendar の連携および Gemini による自動スケジューリングツール。
*   **構成**:
    *   Python 3.x (Windows ローカル)。
    *   API: Google Tasks, Google Calendar, Gemini (google-generativeai)。
    *   DB: ローカルファイル (state_manager) でID紐付けを管理。
    *   除外: GAS, Maps API は使用しない。
*   **同期 (Sync)**:
    *   **対象**: `■` で始まるリストのみ。`■メモ` がInbox。
    *   **Cal -> Tasks**: カレンダーの新規予定を `■メモ` にタスク化。削除・移動はタスクに**影響させない**。
    *   **Tasks -> Cal**: 未スケジュールタスクを分析し、カレンダーの空き枠に登録。
        *   タスク名を `【予定済】...` に変更。
        *   詳細に `[Ref:EventID:xxxxx]` を追記。
*   **振り分け (Organization)**:
    *   起動時に `■メモ` のタスクを各 `■リスト` へ移動。
    *   該当なしは `■メモ` に維持。
*   **分析 (Analysis)**:
    *   Gemini がタスクを分析（所要時間、重要度、場所）。
    *   複合タスクは「サブタスク」に分割。親タスクはコンテナ化（タイトルを `【分割済】...` に変更）。
*   **スケジューリング (Scheduling)**:
    *   優先度: 期限 > 文脈（重要度など）。
    *   移動時間: 15分以上なら「移動イベント」を作成（履歴 または Gemini推測）。

## 2. 矛盾点・懸念点

仕様書を分析した結果、以下の矛盾や論理的な懸念点が見つかりました。これらは実装検に解決（または方針決定）する必要があります。

### 2.1. 同期ループのリスク
*   **現状**: 「カレンダーに予定作成 -> タスク作成」かつ「タスク未スジュール -> カレンダー登録」のロジックが存在します。
*   **問題**: カレンダーで予定を作成 -> ツールがタスクを作成 -> そのタスクを「未スケジュールのタスク」と判定 -> 再度カレンダーに登録、という**無限ループ（二重登録）**が発生する恐れがあります。
*   **解決案**: カレンダーからタスクを作成する際、即座にそのタスクに `[Ref:EventID:xxxxx]` を付与し、さらに「スケジュール済み」とみなすフラグ（またはタイトル接頭辞 `【予定済】`）を適用する必要があります。

### 2.2. カレンダー削除時の不整合
*   **決定事項**: 仕様通り、**カレンダーでの削除はタスクに反映させません**。
*   ユーザー合意により、不整合（タスクが「予定済」のまま残るなど）は許容し、特段の同期処理は実装しません。

### 2.3. 親タスクのコンテナ化の挙動
*   **決定事項**: 親タスクと子タスクの**ステータス連動は行いません**。
*   親タスクは分割時点で役割を終えたコンテナとして扱い、その後の状態変化は子タスクに波及させません。

## 3. やり残していること・未定義事項

実装に向けて詳細化が必要な項目です。

*   **[ToDo] GUIフレームワークの選定**:
    *   要件「簡易GUI」に基づき、モダンなUIが容易な **Flet** (Flutter for Python) または標準の **Tkinter** を採用する。
    *   機能: 「振り分け実行ボタン」「スケジューリング実行ボタン」「ログ表示エリア」。
    *   ※タスクそのものの編集・並べ替え機能は**実装しない**（ユーザーはGoogle Tasks公式側で操作する）。
*   **[ToDo] 移動イベントの定義**:
    *   移動イベントのタイトル形式（例: `移動 (A地点 -> B地点)`）や色（Color ID）の指定がありません。
*   **[ToDo] 履歴データの保存方法**:
    *   「過去の履歴」を参照する仕組みについて、簡単なJSONDBに「出発地:到着地:所要時間」を蓄積する形式で良いか確認が必要です。
*   **[ToDo] タスク変更の同期**:
    *   タスクの内容（メモやタイトル）が後から変更された場合、カレンダーイベントに反映するかどうかが未定義です（現状は作成時のみの記述）。
*   **[ToDo] エラーハンドリング**:
    *   API制限（Quota）やネットワークエラー時の再試行ロジック。

## 3.1. 実装詳細 (Sync: Cal -> Tasks)
*   `src/logic/synchronizer.py` の `sync_calendar_to_tasks` を修正。
*   作成されるタスクのタイトルに `【予定済】` プレフィックスを付与する。
*   これにより、後続のスケジューリング処理で二重登録を防ぐ。

## 5. 検証プラン (Verification Plan)
### 5.1. 自動テストスクリプト (`src/verify_sync.py`)
1.  **事前準備**:
    *   現在時刻から1時間後の予定 ("Test Event") をカレンダーに作成。
2.  **実行**:
    *   `sync_calendar_to_tasks()` を実行。
3.  **検証**:
    *   タスクリスト「■メモ」にタスクが作成されているか確認。
    *   タスク名が `【予定済】Test Event` となっているか確認。
    *   タスクのメモに `[Ref:EventID:...]` が含まれているか確認。
4.  **事後処理**:
    *   作成したテスト用イベントとタスクを削除。

## 4. 次のアクション

1.  上記の矛盾点（特にループ防止と削除時の挙動）について方針を確定する。
2.  プロジェクトのディレクトリ構成を作成する (`src/`, `config/` 等)。
3.  Google API の認証周りのセットアップを行う（`credentials.json` の配置等）。
